<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CPR.AI Bluetooth - Jeevtronics</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="manifest" href="manifest.json" />
<style>
  :root {
    --brand-dark: #1b5e20;
    --brand-mid:  #2e7d32;
    --brand-light:#66bb6a;
    --panel-white: rgba(255,255,255,0.92);
  }

  /* [Previous CSS remains exactly the same until the end] */

  /* Enhanced visual feedback */
  .depth-fill.pulse {
    animation: pulse 0.5s ease-in-out;
  }
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  /* History table styles */
  #historyTable {
    width: 100%;
    border-collapse: collapse;
    margin: 12px 0;
  }
  #historyTable th, #historyTable td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  #historyTable tr:hover {
    background-color: rgba(0,0,0,0.03);
  }

  /* Audio controls */
  .audio-controls {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
  }
  .audio-btn {
    padding: 6px 12px;
    border-radius: 20px;
    border: none;
    background: var(--brand-mid);
    color: white;
    cursor: pointer;
    font-size: 13px;
  }
</style>
</head>
<body>

<!-- [Previous HTML remains exactly the same until before </body>] -->

<!-- Add these new elements before </body> -->
<div class="panel" id="historyPanel" style="display:none;">
  <h3 style="margin-top:0;">Session History</h3>
  <div id="historyTable"></div>
  <button id="clearHistoryBtn" class="btn" style="background:#d32f2f;color:white;margin-top:12px;">Clear History</button>
</div>

<audio id="metronomeAudio" src="audio/metronome.mp3" preload="auto"></audio>
<audio id="feedbackAudio" preload="auto"></audio>

<script>
/* [Previous JavaScript remains exactly the same until the end] */

/* ===== NEW FEATURES IMPLEMENTATION ===== */

/* Session History System */
let sessionHistory = JSON.parse(localStorage.getItem('cprHistory') || [];

function saveSessionToHistory() {
  if (sessionData.length < 5) return; // Don't save very short sessions
  
  const rates = sessionData.map(r => r.rate);
  const depths = sessionData.map(r => r.depth);
  const avgRate = (rates.reduce((a,b) => a + b, 0) / rates.length).toFixed(1);
  const avgDepth = (depths.reduce((a,b) => a + b, 0) / depths.length).toFixed(1);
  const inTargetCount = sessionData.filter(r => r.rate >= 100 && r.rate <= 120).length;
  const pctInTarget = ((inTargetCount / sessionData.length) * 100).toFixed(1);
  
  sessionHistory.unshift({
    date: new Date().toISOString(),
    trainee: traineeName,
    avgRate,
    avgDepth,
    pctInTarget,
    data: sessionData
  });
  
  // Keep only last 50 sessions
  if (sessionHistory.length > 50) sessionHistory.pop();
  
  localStorage.setItem('cprHistory', JSON.stringify(sessionHistory));
}

/* Enhanced Visual Feedback */
function updateDepthBar(depthObj) {
  const depth = depthObj.depth;
  const zone = depthObj.zone || 'red';
  
  // Pulse animation for significant changes
  depthFill.classList.add('pulse');
  setTimeout(() => depthFill.classList.remove('pulse'), 500);

  // Rest of existing depth bar update...
}

/* Audio Feedback System */
let metronomeInterval;
const metronomeAudio = document.getElementById('metronomeAudio');
const feedbackAudio = document.getElementById('feedbackAudio');

function playFeedback(type) {
  const audioMap = {
    'too-fast': 'audio/too-fast.mp3',
    'too-slow': 'audio/too-slow.mp3',
    'too-shallow': 'audio/too-shallow.mp3',
    'good-depth': 'audio/good-depth.mp3'
  };
  
  if (audioMap[type]) {
    feedbackAudio.src = audioMap[type];
    feedbackAudio.play().catch(e => console.log('Audio play failed:', e));
  }
}

function startMetronome() {
  stopMetronome();
  metronomeInterval = setInterval(() => {
    metronomeAudio.currentTime = 0;
    metronomeAudio.play().catch(e => console.log('Metronome play failed:', e));
  }, 600); // 100 BPM (600ms = 60,000ms / 100 beats)
}

function stopMetronome() {
  clearInterval(metronomeInterval);
}

/* Modified handleNotification to include audio feedback */
function handleNotification(raw) {
  // [Previous parsing code...]
  
  if (rate !== null && peaks !== null) {
    // Audio feedback
    if (rate < 100) {
      playFeedback('too-slow');
    } else if (rate > 120) {
      playFeedback('too-fast');
    }
    
    const depthObj = mapPeaksToDepth(peaks);
    if (depthObj.zone === 'red') {
      playFeedback('too-shallow');
    } else if (depthObj.zone === 'green') {
      playFeedback('good-depth');
    }
    
    // Rest of existing handling...
  }
}

/* Modified training flow to handle history */
stopTrainingBtn.addEventListener('click', () => {
  logging = false;
  stopMetronome();
  stopTrainingBtn.style.display = 'none';
  if (sessionData.length > 0) {
    downloadBtn.style.display = 'inline-block';
    saveSessionToHistory();
  }
});

/* Initialize history system on load */
renderHistoryTable();

</script>
</body>
</html>
